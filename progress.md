Original prompt: add the model to the grid.The head piece should fit exactly in a head grid square

- Updated renderer to keep drawing the model when grid-only mode is active.
- Added model scaling in grid-only mode based on the head grid unit so the head piece fits one head grid square.
- Validation: `npm run build` passes after renderer changes.
- Playwright check attempted via skill client, but blocked because `playwright` is not installed (`ERR_MODULE_NOT_FOUND: playwright`).
- Fixed arm click drift in grid mode by matching CanvasGrid pick/drag coordinates to renderer's model projection (same scale + y-offset, plus inverse mapping for IK targets).
- Elbow/forearm pick refinements retained with overlap tie-break in favor of elbow.
- IK anti-flicker pass: switched IK drag smoothing to time-normalized alpha (event-dt aware) and added per-step rotation delta caps so mouse event jitter cannot spike pose updates.
- Slowed response intentionally for stability: larger low-friction target deadzone, lower target/rotation blend alphas, and max angular step limits for low-friction chains.
- Added per-chain IK event timestamp tracking and cleanup on drag start/end to keep smoothing deterministic.
- Validation: `npm run test -- --run` and `npm run build` both pass after smoothing changes.
- Playwright skill-client run attempted; blocked by missing `playwright` package in environment (`ERR_MODULE_NOT_FOUND`).
- Tap flick fix: IK solve is now gated behind a small drag threshold (3.5px) so tap/click selection doesn't trigger a solve pass.
- Added no-op guard in IK drag path when target movement is inside deadzone; avoids solver branch jitter for stationary taps.
- Validation: `npm run test -- --run` and `npm run build` pass after the tap-flick fix.
- Re-tuned anti-flicker to remove introduced pause/stutter:
  - lowered tap arm threshold from 3.5px -> 1.2px,
  - removed hard deadzone-return in IK drag,
  - switched to continuous smoothing with reduced alpha inside deadzone,
  - added tiny solve epsilon (0.02) to ignore true no-op jitter only.
- Validation: `npm run test -- --run` and `npm run build` both pass.
- IK audit/cleanup pass:
  - Removed hidden rigid mode in `App.tsx` that forced `stretchEnabled=false` and `softReachEnabled=false`.
  - Movement defaults now bias for freer IK (`stretch=true`, `softReach=true`, `naturalBend=false`).
  - Exposed Stretch + Soft Reach toggles in CanvasGrid movement controls (removed static "Rigid IK ON" row).
  - Added explicit IK drag profiles (default + primary chains) to centralize smoothing/solver params.
  - Standard effector pick now prefers full-body chains (`l_arm/r_arm/l_leg/r_leg/core`) over short subchains when available.
  - IK drag solve now runs unconstrained (`enforceJointLimits=false`) with tuned smoothing/pole weight to reduce constraint friction.
- Validation: `npm run test -- --run` and `npm run build` both pass.
- Playwright skill loop re-attempted after IK audit; still blocked by missing `playwright` package (`ERR_MODULE_NOT_FOUND`).
- Rollback requested: restored IK interaction stack to pre-"remove the flick" state.
- Reverted tap-guard gating and subsequent audit/profile overrides; restored prior time-based smoothing + low-friction chain settings.
- Reverted App movement toggles to rigid IK baseline behavior present before that request.
- Validation after rollback: `npm run test -- --run` and `npm run build` pass.
- Added optional grid-only "Refine" panel on the left side (opposite FK/IK toggle).
- FK refine mode now exposes two sliders: rotation sensitivity + rotation response.
- IK refine mode now exposes switches for Natural Bend, Handshake, FK360 Root, Extended IK Handles, Prefer Full Chains, and Unconstrained IK.
- Preserved base defaults and behavior: new controls are opt-in and default to current runtime values.
- Validation: `npm run test -- --run` and `npm run build` pass.
- Left FK refine panel now includes per-joint rotation sliders for every joint in hierarchy.
- Added `setJointRotationFromSlider` helper to apply slider changes directly to rotations state path (`rotationsRef`, `lastValidRotationsRef`, `onRotationsChange`).
- FK refine retains global sensitivity/response controls and now adds full joint-level controls below.
- Validation: `npm run test -- --run` and `npm run build` pass.
- Implemented Humanized IK v2 core in runtime:
  - Added `ikProfile`, `ikSolver`, `ikSolveMode`, `legIntentMode`, and human counterpart toggles to movement contract.
  - Added pure helper modules: `ikHumanAssist.ts` (counterbalance/mirror/follow-through/collar-neck) and `ikLegIntent.ts` (walk/sway/sit/jump intent assist).
  - Updated IK drag pipeline in `components/CanvasGrid.tsx` to support solve scopes (`single_chain`, `limbs_only`, `whole_body_graph`), solver selection (`fabrik`, `ccd`, `hybrid`), leg-intent pre-assist, and human-assist post-pass before blend.
  - Added jump trigger support (button + Space key while in IK jump intent).
  - Expanded IK refine UI with profile/solver/scope/leg-intent controls and human-style toggles.
- Updated `ikSolver.ts` with explicit point solvers (`solvePointsFabrik`, `solvePointsCcd`, `solvePointsHybrid`) and exposed `solver` option in `IKSolveOptions`.
- App-level integration:
  - Updated `App.tsx` movement defaults and effective toggles to include all new IK fields while keeping baseline defaults (`base`/`fabrik`/`single_chain`/`none`).
- Tests:
  - Extended `ikSolver.test.ts` for FABRIK/CCD/Hybrid finite solve checks and per-solver length-preservation checks.
  - Added `ikHumanAssist.test.ts` and `ikLegIntent.test.ts`.
- Validation:
  - `npm test` passes (3 files, 12 tests).
  - `npm run build` passes.
- Fixed runtime break after timeline engine API upgrade in `App.tsx`:
  - migrated `AnimationClip` construction to config-object API (`frameCount`, `loop`, `interpolatePose`, keyed keyframes with ids),
  - replaced legacy calls (`setKeyframe`, `removeKeyframe(frame)`, `getPoseForFrame`) with current API (`upsertKeyframe`, `removeKeyframe(id)`, `sampleFrame`),
  - switched ghost sampling to `getGhostFrames({ frame }, config)`,
  - added frame-count guard (`clampFrameCount`) on frame input to avoid invalid zero/NaN timeline configs.
- Validation: `npm run build` passes.
- Playwright validation (skill client):
  - `http://localhost:3001` run passed, screenshot captured, no `errors-*.json` emitted.
  - `http://localhost:3000` run passed, screenshot captured, no `errors-*.json` emitted.
- Audited IK control surface and refactored IK refinement UX for clearer user-driven toggling.
- Added quick IK experience presets in `components/CanvasGrid.tsx`:
  - Precision
  - Balanced Human
  - Expressive
- Added active preset detection (`Custom` fallback) so users can see current state after manual edits.
- Added quick Leg Intent chip controls (None/Walk/Sway/Sit/Jump) with inline Jump trigger.
- Promoted counterpart reaction toggles into a dedicated section when Human profile is active.
- Added collapsible `Advanced Controls` section to keep all detailed toggles/selects accessible without cluttering primary interaction.
- Validation after UX refactor: `npm test` and `npm run build` both pass.
- FK refine sliders now use wrapped 360-degree rotation for all joints:
  - Slider range forced to `-180..180` for every FK joint slider.
  - Slider writes normalize via `normA` (no JOINT_LIMITS clamp).
- Validation after FK slider wrap change: `npm test` and `npm run build` pass.
- Added FK slider auto-wrap at bounds in `components/CanvasGrid.tsx`:
  - Added wrapped slider handler that detects edge hit (`+180`/`-180`) and wraps to the opposite bound.
  - Seeded per-joint previous slider value on mouse-down to make boundary detection deterministic.
  - Reset slider wrap tracking when incoming pose/rotations props refresh.
- Validation after wrap-at-limits behavior: `npm test` and `npm run build` pass.
- Added new on-canvas animation interface in grid mode next to Refine/Animate:
  - New `Anim UI` toggle button in `components/CanvasGrid.tsx`.
  - Floating animation panel with frame nav (Prev/Next), current frame readout, keyframe add/remove, FPS, frame count, and easing selector.
  - Wired to existing app animation state/handlers from `App.tsx` (playback, keyframe ops, timeline settings).
- Validation pending immediately after this note: run `npm run build` and `npm test`.
- Updated head-grid rendering in `renderer.ts` for animation tracking: head grid lines now render only on the right side of each tile's red centerline (left red line remains visible as divider).
- Kept square boundary and centerline rendering unchanged for orientation.
- Added on-canvas left-side head-grid timeline rail in `CanvasGrid`:
  - Head-square slots for pose capture/projection (`SNAP` saves current pose to that frame).
  - Minimize/expand control.
  - Tween step control (slot frame stride).
  - Scroll arrows on both sides of each slot + page arrows at top.
  - Drag/drop between slots swaps keyframe poses (replace behavior).
  - Slot click jumps current frame for editing.
  - Thumbnail projection per slot using simplified skeleton SVG inside each head square.
- App wiring added:
  - Passed keyframe pose map to canvas grid.
  - Added callbacks for save-to-slot and swap-slot keyframes.
- Updated on-canvas animation UX to 1-based frame indexing for users:
  - Frame display now shows `1..frameCount` (no `0` shown).
  - Timeline rail slots now start at Frame 1 and label/save/select using 1-based labels.
  - Internal engine storage remains 0-based for compatibility; UI maps `displayFrame -> internalFrame = displayFrame - 1`.
- Timeline square projection updated in `CanvasGrid`:
  - Pose thumbnail now auto-fits full skeleton head-to-toe into each square via pose bounding-box normalization.
  - Added joint dots in thumbnail for clearer projected pose readability.
- Timeline slot controls reorganized:
  - Frame label + scroll arrows moved above each square.
  - SNAP/EDIT controls moved beside each square (no overlay covering the pose).
- Fixed interpolation shortest-path wrapping bug in `adapters/poseInterpolator.ts` by correcting negative modulo handling for angular deltas.
- Restyled on-canvas head-grid timeline to blend with canvas:
  - Softer glass gradient panel.
  - Lower-contrast borders/buttons.
  - Less saturated slot backgrounds with subtle active frame accent.
- Fixed `CanvasGrid.tsx` runtime TDZ crash: moved `computeWorld` declaration before `computeThumbPosePath` so dependency capture does not access an uninitialized const.
- Validation: `npm run build` passes.
- Playwright skill smoke run against `http://localhost:3000` passed; screenshot captured at `output/web-game/post-computeWorld-order-fix-2026-02-23/shot-0.png` and no `errors-*.json` emitted.
- Fixed App TDZ crash: moved `interpolationFramesBySegment` state hook above `clipRef` initializer so initial `createAnimationClip(...)` call does not read an uninitialized const.
- Validation: `npm run build` passes.
- Playwright skill smoke run against `http://localhost:3000` passed; screenshot at `output/web-game/post-interpolation-tdz-fix-2026-02-23/shot-0.png` with no `errors-*.json` emitted.
- Consolidated grid-mode animation controls into a single left timeline rail in `components/CanvasGrid.tsx`:
  - Removed separate `Animate` button + floating `Anim UI` panel.
  - Added integrated play/pause, prev/next frame, current frame readout, +key/-key, FPS, frame-count, and easing controls directly in the head-grid rail.
- Expanded timeline slot editing so animation can be adjusted fully in one surface:
  - Added per-slot `DEL` action via new `onRemovePoseAtFrame(frame)` callback.
  - Kept drag/swap move behavior and snap/edit actions.
  - Added per-segment tween duration controls (`Auto`, +/- stepper) for keyframe-to-keyframe interpolation in-slot.
- Updated `App.tsx` animation wiring:
  - Passed `segmentInterpolationFrames` + `onSetSegmentInterpolation` + `onRemovePoseAtFrame` into `CanvasGrid`.
  - Clamped custom transition durations to segment span when constructing `AnimationClip` transitions.
  - Added interpolation-map cleanup to drop stale segment overrides when keyframe topology changes.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (12 tests).
  - Playwright skill smoke command completed and wrote `output/web-game/animation-consolidation-2026-02-24/shot-0.png`; no `errors-*.json` artifact was emitted.
- Additional UI-level verification with direct Playwright full-page screenshots (DOM, not canvas-only):
  - `output/web-game/ui-check-2026-02-24/full.png` confirms single consolidated timeline rail is visible (play, frame nav, key ops, fps/frame/easing controls).
  - `output/web-game/ui-check-2026-02-24/with-segment.png` confirms segment tween control appears after creating a second keyframe.
  - `output/web-game/ui-check-2026-02-24/with-segment-adjusted-3.png` confirms segment tween decrement updates display from `10/10` to `9/10`.
- Animation timeline UX update per follow-up request:
  - Renamed `Head Grid Timeline` to `Animation Timeline` in `components/CanvasGrid.tsx`.
  - Added `Timeline On/Off` activator next to the `Refine` button in grid mode; timeline panel now conditionally renders from that toggle.
  - Added wheel scrolling support on the animation timeline panel (`onWheel`) to move through timeline slots (Shift+wheel pages by visible slot count).
  - Added quick/manual frame-gap control (`Frame Gap`) for timeline slot spacing:
    - Quick presets (`1f`, `2f`, `4f`, `8f`) with active state.
    - Manual numeric entry mode for exact frame-gap value.
    - Gap is clamped to clip bounds when frame count changes.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (12 tests).
  - Playwright UI verification screenshots:
    - `output/web-game/timeline-scroll-toggle-2026-02-24/state-1-default.png`
    - `output/web-game/timeline-scroll-toggle-2026-02-24/state-2-timeline-off.png`
    - `output/web-game/timeline-scroll-toggle-2026-02-24/state-3-manual-scroll.png`
- Rotation safety pass: animation playback now runs as read-only preview for authored rotation state.
  - In `App.tsx`, added playback guard so frame-sync (`syncRotationsFromClip`) is skipped while playing.
  - Added `playbackPreviewRotations`/`displayedRotations` and pass preview pose to canvas only during playback.
  - Added guard in `handleRotationsChange` to ignore edit writes while playback is active.
  - Result: animation no longer mutates the working `rotations` edit state while previewing timeline motion.
- Validation: `npm run build` and `npm test -- --run` pass after this change.
- Playback range behavior update requested by user:
  - In `App.tsx`, animation playback no longer wraps over `frameCount`.
  - Added keyframe-bounded playback range resolver (`getPlaybackRange`), and animation now:
    1) plays from current pose within posed range,
    2) auto-stops at the last posed frame,
    3) returns to the first posed frame when the end is reached.
- Added `currentFrameRef` to make playback stepping deterministic and allow stop/return without modulo looping.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes.
  - Playwright verification wrote `output/web-game/auto-end-return-2026-02-24/status.json` showing `{ "frameLabel": "F1/60", "playLabel": "Play" }` after playback from a later keyframe.
- Timeline gap input enhancement:
  - `Frame gap` now always includes a custom numeric text field (`Custom`) alongside the quick/manual mode toggle.
  - Quick preset buttons remain available in quick mode; manual mode now still keeps direct numeric input visible.
- Per-keyframe-break custom input:
  - Each `Tween F..→F..` section now includes its own numeric text field so interpolation duration can be typed directly for that specific keyframe break.
  - Existing `Auto`, `-`, and `+` controls remain.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes.
  - Visual check: `output/web-game/frame-gap-custom-2026-02-24/with-custom-fields.png`.
- Layout update per request:
  - Moved primary grid-mode buttons/toggles to left-side control row: `Drag`, `FK Limits`, `Refine`, `Timeline`.
  - Removed separate top-right `Drag` and `FK Limits` buttons in grid mode.
  - Moved timeline panel to the right side of canvas.
- Timeline visual alignment with Refine panel:
  - Restyled timeline container to match refine-panel visual language (`border rounded shadow-xl backdrop-blur-sm`, same dark panel background/border treatment and header style).
- Kept timeline scrolling behavior and validated after right-side move:
  - Wheel scrolling remains attached to timeline panel.
  - Arrow/page scroll controls remain.
  - Verified via Playwright that timeline advances (e.g., top slot from `F1` to `F5` after scroll-down clicks).
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes.
  - Screenshots:
    - `output/web-game/layout-left-controls-right-timeline-2026-02-24/state-1-layout.png`
    - `output/web-game/layout-left-controls-right-timeline-2026-02-24/state-2-scrolled.png`
    - `output/web-game/layout-left-controls-right-timeline-2026-02-24/state-3-scrolled-via-button.png`
- Refined timeline tween UX in `components/CanvasGrid.tsx`:
  - Replaced redundant `- / +` segment duration controls with a clearer per-segment slider + numeric field.
  - Kept `Auto` reset for full-span interpolation.
  - Added per-break `Add Tween` action that calls `onInsertTweenBetween(from,to)` to insert a singular in-between keyframe.
- Refined IK/AI labels to reduce redundancy and improve clarity in the refine panel:
  - `IK Experience` -> `Solver Style`
  - `Leg Intent` -> `Leg Motion`
  - `Counterpart Reactions` -> `Body Reactions`
  - `Advanced Controls` -> `Advanced`
  - Removed persistent redundant “Current style” line; only shows `Custom style` when user settings no longer match presets.
  - Updated advanced toggle labels for clearer intent (`FK-IK Blend`, `Free Root Rotation`, `Ignore Joint Limits`, etc.).
- Updated quick preset copy to be more direct and less repetitive.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (12 tests).
  - Playwright visual verification screenshots:
    - `output/web-game/ui-refine-tween-2026-02-24/state-3-segment-controls.png`
    - `output/web-game/ui-refine-tween-2026-02-24/state-4-ik-refine-open.png`
    - `output/web-game/ui-refine-tween-2026-02-24/state-5-after-add-tween.png` (confirms `Add Tween` increments keys from 2 -> 3).
- Anti-jitter playback pass (requested):
  - Updated `App.tsx` playback loop from incremental delta stepping to an absolute playback clock (`startTimeMs + fps`) for stable frame progression while playing.
  - Playback still auto-stops at the last posed frame and returns to first posed frame, but now with deterministic time-based progression to reduce micro-jitter.
- Added playback interaction lock in `components/CanvasGrid.tsx`:
  - While `isPlaying`, drag/hover interactions are cleared and mouse editing is blocked.
  - Prevents IK/FK interaction state churn during preview playback.
  - Runtime refs no longer reset IK smoothing/fk slider buffers each playback tick.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (12 tests).
  - Playwright runtime check screenshot: `output/web-game/playback-stability-2026-02-24/state-after-play.png`.
- Added posture assist controls for IK dragging:
  - New movement toggle fields: `postureState` (`stand` | `kneel` | `ground_sit`) and `postureRoll` (0..1).
  - App defaults + effective movement toggles now include posture state/roll.
  - IK refine UI now includes one-tap posture buttons (Stand/Kneel/Ground Sit), roll slider, and quick `Sit Down` / `Stand Up` actions.
- Extended `ikLegIntent.ts` to apply posture-roll offsets independent of active drag chain, enabling smooth roll in/out of kneeling and ground-sit during IK interaction.
- Extended tests in `ikLegIntent.test.ts` for kneel and ground-sit posture roll behavior.
- Validation after posture assist: `npm test` (14 tests) and `npm run build` pass.
- Researched open-source refinement options for IK/posture workflows (THREE.IK, Fullik/FIK, closed-chain-ik-js, Godot SkeletonModification2D + AnimationTree, Blender Rigify/NLA references).
- Validation rerun after posture-roll integration:
  - `npm test -- --run` passes (3 files, 14 tests).
  - `npm run build` passes.
- Researched open-source refinement candidates for sit/kneel/ground-sit IK workflow (for follow-up implementation guidance): three.js CCDIKSolver, jsantell/THREE.IK, gkjohnson/closed-chain-ik-js, Fullik, XState, Blender Rigify.
- UX-first-pass implementation for user-friendliness in `components/CanvasGrid.tsx`:
  - Increased control readability and hit area in grid-mode timeline + refine surfaces (larger typography and larger button/input padding).
  - Replaced shorthand action copy with explicit labels across primary controls and timeline actions.
    - Examples: `Drag` -> `Interaction`, `FK Limits` -> `Joint Limits`, `Refine` -> `Motion Settings`, `+Key/-Key` -> `Add/Remove Keyframe`, `SNAP/EDIT/DEL` -> `Capture Pose/Select Frame/Clear Pose`.
  - Added a new `Basic/Advanced` mode split for both timeline and refine panels.
    - Timeline basic mode keeps core playback/keyframe/slot controls.
    - Timeline advanced mode exposes detailed timing and interpolation controls (fps/frame/easing, page scroll, frame-step presets/manual, tween duration controls).
    - Refine basic mode keeps core FK/IK controls.
    - Refine advanced mode unlocks per-joint FK sliders plus posture/body-reaction/expert IK controls.
  - Added mode state and guardrails:
    - `timelinePanelMode` (`basic` | `advanced`)
    - `refinePanelMode` (`basic` | `advanced`)
    - Auto-hides nested IK expert controls when refine mode returns to basic.
  - Updated timeline sizing heuristics for larger controls (`timelineRailWidth`, `timelineSlotsVisible`) to reduce crowding.
- Validation after UX-first-pass:
  - `npm run build` passes.
  - `npm test -- --run` passes (3 files, 14 tests).
  - Playwright client run succeeds with elevated sandbox and outputs screenshot artifact:
    - `output/web-game/ui-first-pass-2026-02-24/shot-0.png`
  - Note: this client capture is canvas-focused and does not include full DOM overlay panels in the output image.
- Follow-up fix after UX-first-pass:
  - Exposed timeline mode toggle in header (`Mode: Basic/Advanced`) so advanced controls are user-reachable.
  - Added safe upper-bound clamp for `Next Frame` navigation in timeline controls to prevent stepping beyond last frame.
- Re-validation after follow-up fix:
  - `npm run build` passes.
  - `npm test -- --run` passes (3 files, 14 tests).
- Final Playwright skill-client rerun after follow-up UX fix:
  - Command completed and wrote screenshot artifact: `output/web-game/ui-first-pass-2026-02-24-final/shot-0.png`.
- IK pinning + scope refinement pass for user report ("Balanced shoots legs up"):
  - Removed stale all-chain target reuse during IK drag; solve now builds target set from active drag target + intent assists + optional ground pins only.
  - Added drag-seeded ground pin capture for leg effectors and selective pin application (both legs for non-leg drags, opposite leg for leg drags) in non-single-chain solve modes.
  - Ground pins auto-relax for sit/jump/posture-roll workflows to avoid fighting deliberate leg folding.
- Grid/model baseline alignment pass:
  - Grid baseline (bottom head line + ring circle bottom) now anchors to canvas bottom in grid-only mode.
  - Model projection y-offset now derives from reference heel world position so default feet align with baseline.
  - Synced head-grid hover projection math to updated grid y-offset.
- Validation:
  - `npm test -- --run` passes (14/14).
  - `npm run build` passes.
  - Playwright smoke run succeeded after escalation; screenshot: `output/web-game/pinning-grid-baseline-2026-02-24/shot-0.png`.
- Dynamic frame count update:
  - `App.tsx` now initializes animation timeline with `frameCount = 1` (instead of a fixed 60).
  - Added `ensureFrameCapacity(frame)` helper to grow clip capacity on demand when navigating/saving into higher frames.
  - Added `handleSetCurrentFrame(frame)` that auto-expands timeline length before setting current frame.
  - Wired `handleSetCurrentFrame` into timeline strip and `CanvasGrid` frame setter callbacks.
- Timeline controls/menu minimization update:
  - Added `timelineControlsMinimized` state in `components/CanvasGrid.tsx`.
  - Added header toggle (`Controls: Shown/Hidden`) to collapse/expand controls above frame slots.
  - Frame-slot visibility now increases when controls are hidden (more slots shown in right panel).
- Frame navigation behavior for dynamic growth:
  - `Next Frame` now increments frame index without clamping to current frameCount max, enabling on-demand frame growth.
  - `Previous Frame` remains clamped at frame 1 boundary.
  - Default timeline frame-step changed from 2 to 1 so newly added frames are visible immediately.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (14 tests).
  - Playwright screenshots:
    - `output/web-game/dynamic-frames-menu-collapse-2026-02-24/state-1-initial.png`
    - `output/web-game/dynamic-frames-menu-collapse-2026-02-24/state-2-after-next.png` (shows frame counter grows to `FRAME 2/2`)
    - `output/web-game/dynamic-frames-menu-collapse-2026-02-24/state-3-controls-hidden.png` (controls collapsed, more frame tiles visible)
- Layout pass for requested 4:3 + full-height timeline console:
  - `components/CanvasGrid.tsx` now reserves right-side width for timeline as `TIMELINE_RAIL_WIDTH + gap` and computes a centered 4:3 `sceneViewport` in the remaining left area.
  - Updated interaction/world centers in grid mode to use `sceneViewport.center` (FK/IK handshake, mouse down/move solving paths) so drag math stays aligned with the recentered viewport.
  - Renderer call now passes `viewWindow: sceneViewport` so grid/circle/figure projection uses the same 4:3 viewport contract.
  - Right timeline panel now anchors `top:0; bottom:0; right:0` and uses full-height flex layout (`h-full`) with scrollable frame-list region.
  - Top console buttons now behave as console selection: selecting `Motion Settings` turns `Timeline Panel` off, selecting `Timeline Panel` turns `Motion Settings` off.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (14/14).
  - Playwright DOM-level verification screenshots:
    - `output/web-game/layout-top-bottom-2026-02-24-dom/state-timeline-selected.png`
    - `output/web-game/layout-top-bottom-2026-02-24-dom/state-motion-selected.png`
    - `output/web-game/layout-top-bottom-2026-02-24-dom/state-timeline-reselected.png`
  - Captured button-state check during run:
    - timeline on label observed
    - selecting Motion toggles Timeline off
    - reselecting Timeline toggles Motion off
- Jitter fix (animation active) in grid-mode projection:
  - Root cause: projection ground anchoring was derived from `bitruviusData.initialRotations`, which in this app is the live animated pose during playback. This caused per-frame y-offset drift/jitter.
  - `components/CanvasGrid.tsx` now computes projection anchor from a stable reference pose (`T-Pose` fallback `Neutral`) via `projectionReferenceRotations` and uses that for heel-based model y-offset.
  - `renderer.ts` now mirrors the same stable projection anchor (`T-Pose`/`Neutral`) for renderer-side model projection offset.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (14 tests).
  - Playwright screenshots for post-fix sanity captured in `output/web-game/jitter-fix-2026-02-24/`.
- Pose capture fix + simplification pass:
  - `components/CanvasGrid.tsx` timeline slot labels are no longer clamped to `frameCount`; slots now show sequential target frames (e.g., Frame 1, Frame 2, Frame 3) even when starting from a 1-frame clip.
  - Added virtual timeline range (`timelineVirtualFrameCount`) so users can scroll/capture into future frames before they exist in clip storage.
  - Increased frame-step ceiling baseline (`maxTimelineStepFrames`) so quick gap presets remain usable in tiny clips.
  - Simplified timeline copy and capture actions:
    - top buttons `Add Keyframe` -> `Capture Current`, `Remove Keyframe` -> `Clear Current`
    - per-slot removed redundant `Select Frame` button; slot click still selects frame, single action button is now `Capture Here`.
- `App.tsx` capture behavior simplified:
  - `handleSavePoseToFrame` now also moves current frame to the captured slot for direct continuation (`FRAME n/n` updates immediately).
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (14 tests).
  - Playwright verification: `output/web-game/capture-simplify-2026-02-24/timeline-capture-simplified.png`
  - DOM check confirmed sequential slot labels and capture-to-frame update (`topFrameLabel: FRAME 2/2`).
- Added requested timeline footer controls in `components/CanvasGrid.tsx`:
  - New bottom `Back to 1` button (returns to frame 1 / internal frame 0). If playback is active, it pauses first via existing toggle and then jumps to frame 1.
  - New motion-function quick buttons: `Fluid`, `Elastic`, `Rigid`, `Snapback`.
  - Function presets map to easing selections:
    - Fluid -> `easeInOutQuad`
    - Elastic -> `easeOutQuad`
    - Rigid -> `linear`
    - Snapback -> `easeInQuad`
  - Active function button reflects current easing state.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (14 tests).
  - Playwright check confirms all controls visible in timeline footer and screenshot saved to:
    - `output/web-game/timeline-footer-functions-2026-02-24/timeline-footer-functions.png`
- IK refine UX cleanup pass:
  - Renamed top-left toggle to `Refine` and widened refine panel (`320px`) for readability.
  - Reorganized IK panel into clearer sections for quick use: `IK Presets`, `Pose + Weight`, `Leg Motion`, and `Posture` always visible.
  - Added directional quick pose buttons (`Front/Left/Right/Back`) plus `Weight Shift (L/R)` and `Depth Shift (Back/Front)` sliders.
  - Added one-tap `Reset Pose` and `Neutral Stance` actions.
  - Kept solver internals and body-reaction toggles in Advanced mode.
- Runtime behavior additions for new controls:
  - Added `poseDirection`, `weightShiftLateral`, `weightShiftDepth` to movement toggles contract and app defaults/effective toggles.
  - Added directional + weight shift assist in `ikLegIntent.ts` so IK drag applies pelvis/torso/leg biasing for left/right/back/front posing.
- Tests/build:
  - `npm test -- --run` passes (3 files, 16 tests).
  - `npm run build` passes.
- Visual smoke:
  - Playwright canvas capture succeeded: `output/web-game/ik-refine-ux-weights-2026-02-24/shot-0.png`.
- Phase 1 (background/foreground upload pipeline) implemented across app + renderer:
  - `renderer.ts` now accepts `backgroundLayer` and `foregroundLayer` in `RenderOptions`, caches layer images by URL, and renders BG before grid/model + FG after model/debug overlays.
  - `App.tsx` now owns `ImageLayerState` for BG/FG, with blob URL lifecycle handling (`URL.createObjectURL` + revoke on replace/clear/unmount).
  - `App.tsx` now passes upload/clear/patch callbacks and current BG/FG layer state into `CanvasGrid`.
  - `components/CanvasGrid.tsx` now includes advanced timeline controls for BG/FG upload, clear, visibility, opacity, X/Y position, scale, and foreground blend mode.
  - `components/CanvasGrid.tsx` now forwards BG/FG layer state to the renderer call.
- Validation after BG/FG integration:
  - `npm run build` passes.
  - `npm test -- --run` passes (3 files, 16 tests).
  - Playwright skill-client run required unsandboxed execution due Chromium sandbox/Mach port restriction in sandbox; successful artifact captured at `output/web-game/bg-fg-upload-phase1-2026-02-24/shot-0.png`.
- Note: current Playwright client artifact is canvas-focused and does not include DOM overlay panels, so timeline-panel controls were validated primarily via code path + compile/test checks in this pass.
- Updated top-left console toggles to allow concurrent IK/FK controls + animation timeline visibility.
- `components/CanvasGrid.tsx` changes:
  - `Motion Settings` button now only toggles `showRefineMenu`.
  - `Timeline Panel` button now only toggles `showAnimationTimeline`.
  - Removed prior auto-close coupling between these two consoles.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (14 tests).
- Added programmable directional IK pose slots directly in app refine UI:
  - New persistent slot system for `Front/Left/Right/Back` pose programs with localStorage (`canvas-grid.ikPosePrograms.v1`).
  - Each slot now has `Apply` + `Set` workflow (`Set` captures current pose-direction, weight shifts, posture, and leg-motion mode).
  - Added sanitization for stored program payloads and safe fallback defaults.
- IK refine UX adjustments:
  - Renamed top-left control to `Refine`.
  - Widened refine panel to `320px` for clearer control density.
- Validation after programming workflow:
  - `npm test -- --run` passes (3 files, 16 tests).
  - `npm run build` passes.
- Phase 2 (upload UX polish) implemented for image layers:
  - Added `fitMode` support to `ImageLayerState` in `renderer.ts` (`free` | `contain` | `cover`).
  - Renderer `drawImageLayer` now supports fit-based scaling against the viewport while preserving opacity/position/scale controls.
  - `App.tsx` default layer states now include `fitMode: 'free'`.
  - Upload behavior now resets each new BG/FG image to clean defaults (centered, visible, 100% scale, free fit) to reduce carry-over confusion from prior image settings.
  - `components/CanvasGrid.tsx` image-layer panel now includes:
    - Fit mode selectors (Free / Contain / Cover) for BG and FG.
    - Per-layer Reset buttons (`Reset BG`, `Reset FG`) restoring default transform/visibility and FG blend mode.
- Validation after phase 2:
  - `npm run build` passes.
  - `npm test -- --run` passes (3 files, 16 tests).
  - Playwright skill-client verification artifact captured at:
    - `output/web-game/bg-fg-upload-phase2-fit-reset-2026-02-24/shot-0.png`
- Replaced Animation tab surfaces with a local Pose Library workflow in `Bitruvius-Core-Motion/src/rig-adapter/RigCoreV2Shell.tsx`:
  - Top workflow button label now `Pose Library` (animation slot takeover).
  - Sidebar/module title now `Pose Library`.
  - Animation module render path now mounts `PoseLibraryPanel`.
  - Canvas menu section renamed to `Pose Library Canvas Menu` and now mounts `PoseLibraryPanel`.
- Added new local-only `Bitruvius-Core-Motion/src/rig-adapter/PoseLibraryPanel.tsx`:
  - Capture current rig pose into library entries.
  - Apply selected pose to rig.
  - Update/duplicate/delete/clear library entries.
  - Export selected pose or full library to JSON text.
  - Import poses from pasted JSON or local `.json` file.
  - Accepts snapshot shapes: direct snapshot, `{ snapshot }`, array of snapshots/wrappers, or `{ poses: [...] }`.
- Validation:
  - `cd Bitruvius-Core-Motion && npm run typecheck` pass.
  - `cd Bitruvius-Core-Motion && npm run lint` pass.
  - `cd Bitruvius-Core-Motion && npm run test` pass (9 files / 35 tests).
  - `cd Bitruvius-Core-Motion && npm run build` pass.
- Playwright skill-client attempt (`node web_game_playwright_client.js ...`) failed in sandbox due Chromium launch permission error (`bootstrap_check_in ... Permission denied (1100)`).
- Seeded Pose Library with a built-in universal starter set in `Bitruvius-Core-Motion/src/rig-adapter/PoseLibraryPanel.tsx`.
  - Added preset templates: Neutral Standing, T-Pose, A-Pose, Contrapposto, Walk Contact Left/Right, Run Contact Left/Right, Crouch, Jump Anticipation, Jump Apex, Landing, Reach Up, Reach Forward, Seated.
  - Pose library now initializes with these presets by default (local-only; no internet).
  - Added `Add Universal Poses` button to re-feed/append missing presets on demand (name-deduped).
  - Preset generation now clears IK targets/poles and applies FK-friendly starter snapshots for consistent apply behavior.
- Validation:
  - `cd Bitruvius-Core-Motion && npm run typecheck` pass.
  - `cd Bitruvius-Core-Motion && npm run lint` pass.
  - `cd Bitruvius-Core-Motion && npm run test` pass (9 files / 35 tests).
  - `cd Bitruvius-Core-Motion && npm run build` pass.
- Flicker-reduction pass in IK drag loop (`components/CanvasGrid.tsx`):
  - switched deadzone behavior from hard target freeze to distance-scaled continuous smoothing,
  - added micro-target hold epsilon to ignore sub-pixel pointer noise,
  - added rotation apply epsilon so sub-visual solve jitter does not dispatch state updates,
  - added epsilon-based IK target state merge to avoid unnecessary render churn when target deltas are tiny.
- Validation: `npm run build` passes.
- Playwright skill smoke run against `http://localhost:3000` passed; screenshot at `output/web-game/post-flicker-reduction-2026-02-23/shot-0.png` with no `errors-*.json` emitted.
- Timeline tween usability update (`components/CanvasGrid.tsx`):
  - `In-Betweens` decrement/increment controls and `+ Auto Save Tween` now show in both `Basic` and `Advanced` timeline modes.
  - Advanced mode still keeps the duration slider/number and `Use Auto`; basic mode keeps a simplified card with direct in-between +/- and autosave tween.
- Validation after timeline tween update:
  - `npm run build` passes.
  - `npm test -- --run` passes (3 files, 16 tests).
- Playwright check in this environment is still limited by sandbox browser constraints; attempted run produced a screenshot at `output/web-game/inbetween-autosave-check-2026-02-24/shot-0.png` but interactive selector click timed out.
- Added `Lotte` mode inspired by Lotte Reiniger silhouette-film aesthetics.
- Runtime wiring:
  - New app-level `lotteMode` state in `App.tsx`.
  - Added `Lotte On/Off` toggle in grid-top control row (and non-grid toolbar parity button).
  - Added `lm` token to standardized state string encode/decode.
  - Passed `lotteMode` through `CanvasGrid` into renderer.
- Renderer treatment (`renderer.ts`) when `lotteMode` is enabled:
  - Parchment-style radial background fill.
  - Sepia/bronze grid + ring palette remap.
  - Silhouette-first body rendering with warm cutout edge highlights.
  - Warm connector/joint colors for paper-cut style contrast.
  - Added subtle film-look overlay (vignette, dust/scratch speckle, frame border).
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (3 files, 16 tests).
  - Playwright skill-client run completed and artifact captured: `output/web-game/lotte-mode-verified-2026-02-24/shot-0.png`.
  - Additional unsandboxed Playwright probe verified button state change and visual canvas delta:
    - Button text transition: `Lotte Off` -> `Lotte On`.
    - Canvas snapshot size delta: `302073` -> `889870` bytes.
    - Probe artifacts:
      - `output/web-game/lotte-probe-before-2026-02-24.png`
      - `output/web-game/lotte-probe-after-2026-02-24.png`
- Increased default IK interaction speed to ~2x in `CanvasGrid`:
  - Added `IK_SPEED_MULTIPLIER = 2` and alpha-scaling helper.
  - Scaled target smoothing alphas and rotation blend alphas to match doubled response.
  - Doubled per-frame rotation step caps for both normal and low-friction chains.
- Validation:
  - `npm test -- --run` passes (16/16).
  - `npm run build` passes.

- System audit (top-to-bottom) run completed.
- Health checks:
  - `npm test` passed: 3 files, 16 tests.
  - `npm run build` passed.
  - `npm run lint` failed: 356 problems total (333 errors, 23 warnings).
  - Lint breakdown by area (machine-parsed):
    - `Bitruvius-Core-Motion`: 320 errors, 16 warnings
    - active app surface (`App.tsx`, `components`, `renderer.ts`, `ikSolver.ts`): 13 errors, 7 warnings
- Runtime smoke (develop-web-game Playwright client):
  - Initial run blocked by sandbox browser launch permissions.
  - Escalated run succeeded and captured screenshot:
    - `output/web-game/system-audit-2026-02-24/shot-0.png`
  - No `errors-*.json` generated.
  - No `state-*.json` generated because `window.render_game_to_text` is not exposed by current active app.

## TODO / Suggestions For Next Agent
- Security/portability:
  - Remove frontend injection of `GEMINI_API_KEY` via Vite `define`.
  - Replace hardcoded external alias (`../FrankenBitruvius/...`) with local package/workspace dependency strategy.
- Lint posture:
  - Decide whether `Bitruvius-Core-Motion` should be linted in this repo. If not, add explicit ignore(s); if yes, schedule debt reduction.
- Active app lint blockers (small targeted fixes):
  - `App.tsx`: recursive `animate` callback lint violation + unused `majorGridSize`.
  - `components/CanvasGrid.tsx`: ref read during render (`rotationsRef.current`) in advanced FK slider map + stale unused FK constants.
  - `renderer.ts` and `ikSolver.ts`: remove/resolve unused assignments.
- Testability:
  - Add `window.render_game_to_text` and `window.advanceTime(ms)` bridge in the active app to unlock deterministic runtime assertions in Playwright audits.
- Repo hygiene:
  - Investigate/remove tracked placeholder binary files `[full_path_of_file_1]` and `[full_path_of_file_2]`.
- Implemented shared FK runtime module `fkEngine.ts`:
  - Added reusable FK world-transform functions (`computeJointWorldForPose`, `computeWorldPoseForSkeleton`).
  - Added FK animation utilities:
    - keyframe sampling with shortest-angle interpolation + loop support (`sampleFkAnimation`),
    - procedural FK overlay presets (`idle_breath`, `walk_cycle`) with per-joint limit clamping (`applyFkAnimationOverlay`).
- Integrated FK engine into active runtime:
  - `components/CanvasGrid.tsx` now imports/uses shared FK world transform helper instead of local duplicated implementation.
  - Added FK animation controls in FK Refine panel:
    - `FK Anim On/Off`
    - preset selector (`Idle Breath`, `Walk Cycle`)
    - intensity slider
    - speed slider
- App-level animation/runtime wiring in `App.tsx`:
  - Added FK animation movement toggles defaults/state plumbing (`fkAnimationEnabled`, `fkAnimationPreset`, `fkAnimationIntensity`, `fkAnimationSpeed`).
  - During playback preview, sampled timeline pose is optionally layered through `applyFkAnimationOverlay` when FK animation is enabled.
  - Added deterministic runtime bridges for automated testing:
    - `window.render_game_to_text` now returns concise JSON state including FK animation status + joint world coordinates.
    - `window.advanceTime(ms)` now advances timeline frames deterministically over the current playback keyframe range.
- Added unit coverage in new `fkEngine.test.ts`:
  - FK world transform consistency,
  - full world-map generation,
  - shortest-angle keyframe interpolation,
  - looped keyframe frame-wrap sampling,
  - FK animation overlay joint-limit clamping.
- Validation:
  - `npm test` passes (4 files, 21 tests).
  - `npm run build` passes.
  - Playwright skill-client run (escalated for Chromium launch) against local app succeeded:
    - screenshot: `output/web-game/fk-engine-animation-2026-02-24/shot-0.png`
    - text state: `output/web-game/fk-engine-animation-2026-02-24/state-0.json`
    - no `errors-*.json` artifact emitted.
- FK trim-back pass per latest request (pure FK focus):
  - Removed FK animation overlay runtime and controls from active app surface.
    - `App.tsx` playback preview now samples timeline pose directly (no procedural FK overlay stage).
    - `components/CanvasGrid.tsx` FK refine panel no longer shows FK animation preset/intensity/speed controls.
  - Added explicit FK logic toggles for bend/stretch propagation, each independent and default OFF:
    - new movement toggles: `fkBendEnabled`, `fkStretchEnabled`.
    - FK drag solve path now applies bend offsets only when `fkBendEnabled` is true, and stretch offsets only when `fkStretchEnabled` is true.
    - defaults wired in app state/effective toggles so both are false at startup.
  - Updated test text-state payload to expose pure-FK assist flags:
    - `fkAssist: { bendEnabled, stretchEnabled }`.
- Validation:
  - `npm test` passes (4 files, 21 tests).
  - `npm run build` passes.
  - Playwright skill-client verification (escalated Chromium launch) succeeded:
    - screenshot: `output/web-game/fk-pure-bend-stretch-2026-02-24/shot-0.png`
    - text state: `output/web-game/fk-pure-bend-stretch-2026-02-24/state-0.json`
    - state confirms `fkAssist.bendEnabled=false` and `fkAssist.stretchEnabled=false` by default.
    - no `errors-*.json` artifact emitted.
- FK live-redraw regression fix:
  - Root cause: canvas render effect in `components/CanvasGrid.tsx` was not dependent on `currentRotations`, so FK drag updates mutated state but draw pass did not re-run continuously.
  - Fix: added `currentRotations` to the render effect dependency list so FK visual updates render during drag (not only on release).
- Validation:
  - `npm test` passes (4 files, 21 tests).
  - `npm run build` passes.
  - Playwright verification (escalated Chromium launch) succeeded:
    - `output/web-game/fk-live-redraw-fix-2026-02-24/shot-0.png`
    - `output/web-game/fk-live-redraw-fix-2026-02-24/state-0.json`
    - no `errors-*.json` artifact emitted.
- FK live posing + constraints-default update:
  - `App.tsx`
    - Set FK constraints default to OFF in movement defaults (`fkConstraintsEnabled: false`).
    - Effective FK constraints now default false unless explicitly enabled (`movementToggles.fkConstraintsEnabled === true`).
    - Increased real-time keyframe/version refresh cadence during FK drag from 120ms to 16ms so FK animation/timeline feedback updates feel live while posing.
  - `components/CanvasGrid.tsx`
    - Set FK constraints default fallback to OFF (`fkConstraintsEnabled = false`).
    - Enabled live FK posing while playback is active by allowing mouse-move FK/ROOT drag updates during play; non-FK interactions still cancel while playing.
    - Updated Joint Limits UI toggle fallback/default state to OFF (`?? false`), including button visuals and label text.
- Validation:
  - `npm test` passes (4 files, 21 tests).
  - `npm run build` passes.
- Playwright skill-client run (escalated Chromium launch) succeeded:
  - screenshot: `output/web-game/fk-live-pose-constraints-off-2026-02-24/shot-0.png`
  - state: `output/web-game/fk-live-pose-constraints-off-2026-02-24/state-0.json`
  - no `errors-*.json` artifact emitted.

- Added auto-crop for body-mask uploads, expanded background/foreground scale controls with huge-range sliders, and replaced the refine popup with a left-side posing console that mirrors the animation rail while keeping the top button row on the portal.
- Validation: `npm run build`, `npm run test -- --run`; Playwright skill-client run blocked by `node` complaining `Cannot use import statement outside a module` when loading `$WEB_GAME_CLIENT`.

- Simplified grid/ring/model coupling to a single live runtime geometry contract (root app only; no timeline save-flow changes):
  - Added new adapter API in `adapters/vitruvianGrid.ts`:
    - `VitruvianViewportInput`
    - `VitruvianRuntimeGeometry`
    - `createVitruvianRuntimeGeometry(...)`
    - shared `HEAD_PIECE_MODEL_BOUNDS`
    - unified helpers for world/screen projection, model projection, and head-grid cell resolution.
  - Refactored `components/CanvasGrid.tsx`:
    - removed duplicated local `gridProjection` + `headGridHoverMetrics` pipelines,
    - now derives both interaction mapping (`toDisplayPoint`/`fromDisplayPoint`) and head-grid hover mapping from one `runtimeGeometry` memo,
    - timeline square sizing now uses `runtimeGeometry.headGridSquarePx`,
    - passes `runtimeGeometry` into renderer.
  - Refactored `renderer.ts`:
    - `RenderOptions` now accepts optional `runtimeGeometry`,
    - render path now consumes shared runtime geometry for grid/rings/model projection math,
    - fallback runtime geometry creation is centralized through adapter helper when not provided.
  - Simplified visual module profile coupling in `App.tsx`:
    - removed dual-profile constants/state (`3000/3001`) and replaced with a single runtime `visualModules` source,
    - standardized state string now emits a single `vm:` token while legacy tokens remain safely ignored by parser.
  - Added adapter invariants tests in `adapters/vitruvianGrid.runtime.test.ts`:
    - world->screen->world round-trip tolerance,
    - grid-only baseline anchoring for projected reference heel,
    - head-grid square + ring-step consistency checks.
- Validation after refactor:
  - `npm test -- --run` passes (5 files, 24 tests).
  - `npm run build` passes.
  - Playwright smoke (escalated Chromium launch) succeeded against `http://localhost:3000`:
    - screenshot: `output/web-game/runtime-geometry-coupling-2026-02-24/shot-0.png`
    - state: `output/web-game/runtime-geometry-coupling-2026-02-24/state-0.json`
- FK default-fluidity stabilization pass (flicker cleanup):
  - `components/CanvasGrid.tsx`: reworked FK drag update to use event-time smoothing against a persisted per-joint target rotation (`fkTargetRotationRef`) instead of directly applying raw per-event deltas.
  - Added FK jitter guards + stability clamps:
    - pointer-noise delta epsilon (`FK_ROTATION_NOISE_EPSILON_DEG`),
    - visual-apply epsilon (`FK_ROTATION_APPLY_EPSILON_DEG`) to skip micro no-op updates,
    - per-frame max angular step cap (`FK_ROTATION_STEP_MAX`) scaled by event `dt`.
  - Added FK drag lifecycle refs/cleanup (`fkLastEventTsRef`, `fkTargetRotationRef`) and explicit cleanup on mouse up/leave.
  - Added `rootRotateRef` synchronization so root FK drag does not rely on potentially stale toggle props during rapid input.
- Default FK responsiveness tuning:
  - `App.tsx` default movement toggles now start with `fkRotationSensitivity: 1` and `fkRotationResponse: 1` for fluid baseline behavior.
  - `CanvasGrid` fallback defaults for those values also set to `1`.
- Validation after FK fluidity fix:
  - `npm run test -- --run` passes (4 files, 21 tests).
  - `npm run build` passes.
  - Playwright skill-client verification (escalated Chromium launch) succeeded:
    - screenshot: `output/web-game/fk-default-fluidity-fix-2026-02-24/shot-0.png`
    - state: `output/web-game/fk-default-fluidity-fix-2026-02-24/state-0.json`
    - no `errors-*.json` artifact emitted.
- Added per-body-part mask upload pipeline with mode controls (`projection` / `costume`) for all renderable body pieces.
  - `renderer.ts`:
    - Added `BodyPartMaskLayer` + `BodyPartMaskMode` and new `RenderOptions.bodyPartMasks`.
    - Added reusable shape-path helper to keep mask clipping aligned to part silhouettes.
    - Added per-part mask draw pass centered on each part's **parent anchor** (fallback to own joint for root-like cases).
    - `projection` mode now clips mask image to the piece silhouette.
    - `costume` mode now overlays full mask image on the piece transform without clipping.
  - `App.tsx`:
    - Added `bodyPartMaskLayers` state + blob URL lifecycle management per joint.
    - Added callbacks for upload/clear/patch per body part and wired into `CanvasGrid` props.
  - `components/CanvasGrid.tsx`:
    - Added props + hidden upload input for body-part mask files.
    - Added advanced timeline panel UI section `Body Masks` listing all renderable parts with per-part Upload/Clear, mode selector, visibility toggle, opacity, and scale controls.
    - Passed `bodyPartMasks` into renderer call.
- Added animated wheel scrolling for the **entire** timeline console surface (not slot list only):
  - timeline controls container is now the single scroll surface (`overflow-y-auto`) with smooth scroll animation driven by RAF.
  - removed nested slot-only scroll container to avoid scroll-trap behavior.
  - maintained manual timeline slot scroll controls/buttons.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (6 files / 31 tests).
  - Playwright skill client run (local `.mjs` execution) generated canvas artifacts:
    - `output/web-game/body-mask-console-scroll-2026-02-24/shot-0.png`
    - `output/web-game/body-mask-console-scroll-2026-02-24/shot-1.png`
    - `output/web-game/body-mask-console-scroll-2026-02-24/shot-2.png`
  - Direct Playwright DOM verification on fresh Vite port confirmed whole-console scroll movement:
    - before/after scrollTop `0 -> 772`
    - evidence: `output/web-game/body-mask-console-scroll-2026-02-24/console-scroll-check-fresh.json`
    - screenshots: `console-before-scroll-fresh.png`, `console-after-scroll-fresh.png`.
- Advanced per-segment IK tween system implemented (preview-only, non-destructive FK source):
  - Added new shared module `animationIkTween.ts` with:
    - `SegmentIkTweenKey`, `SegmentIkTweenSettings`, `SegmentIkTweenMap`
    - `DEFAULT_SEGMENT_IK_TWEEN_SETTINGS`
    - helpers: `segmentKey`, `normalizeSegmentIkTweenSettings`, `pruneSegmentIkTweenMap`
    - runtime preview overlay: `sampleIkTweenPreviewPose(...)`
  - Runtime behavior:
    - FK keyframes remain source truth from `AnimationClip`.
    - IK tween overlay is applied only to displayed timeline preview pose path.
    - Segment-aware alpha uses segment duration override + selected easing.
    - Supports solver (`fabrik`/`ccd`/`hybrid`), scope (`single_chain`/`limbs_only`/`whole_body_graph`), hands/feet/head inclusion, natural bend, soft reach, joint limits, damping, and influence blend.
    - Graceful fallback: failed/non-finite chains are skipped; FK sample is returned if no successful solves.
- App integration (`App.tsx`):
  - Added `segmentIkTweenMap` state.
  - Extended undo/redo `TimelineHistorySnapshot` with `segmentIkTweenMap` and restore support.
  - Added `handlePatchSegmentIkTween(fromFrame, toFrame, patchOrNull)` with normalization/clamping and null-reset behavior.
  - Added stale-key pruning effect for `segmentIkTweenMap` keyed off current valid keyframe segments.
  - Playback/scrub preview now uses `sampleIkTweenPreviewPose(...)`; authored `rotations` remain FK-source and are not implicitly baked.
  - Wired new props into `CanvasGrid`.
- Timeline UI integration (`components/CanvasGrid.tsx`):
  - Extended props with `segmentIkTweenMap` and `onPatchSegmentIkTween`.
  - Segment card now shows compact status text: `IK Tween: Off` / `IK Tween: On (xx%)`.
  - Advanced mode segment cards now include full `IK Tween` controls:
    - On/Off toggle
    - Influence slider
    - Solver select
    - Scope select
    - Hands/Feet/Head toggles
    - Natural Bend / Soft Reach / Joint Limits toggles
    - Damping slider
    - Reset IK Tween (remove override)
- New test coverage (`animationIkTween.test.ts`):
  - Disabled => FK output unchanged
  - Influence 0 => FK output unchanged
  - Hands-only scope changes arm chain while non-target chains stay near FK
  - Scope escalation includes broader chain influence
  - Solver modes (`fabrik`/`ccd`/`hybrid`) return finite output
  - Joint-limits toggle behavior verified
  - Stale-key pruning verified
- Validation:
  - `npm run test -- --run` passes (6 files, 31 tests).
  - `npm run build` passes.
  - Playwright skill-client run produced artifacts:
    - `output/web-game/ik-tween-segment-2026-02-24/shot-0.png`
    - `output/web-game/ik-tween-segment-2026-02-24/shot-1.png`
    - `output/web-game/ik-tween-segment-2026-02-24/state-0.json`
    - `output/web-game/ik-tween-segment-2026-02-24/state-1.json`
  - Additional DOM-level Playwright captures for timeline segment IK controls + playback topology check:
    - `output/web-game/ik-tween-segment-2026-02-24-dom/state-dom-segment-advanced.png`
    - `output/web-game/ik-tween-segment-2026-02-24-dom/state-dom-ik-on.png`
    - `output/web-game/ik-tween-segment-2026-02-24-dom/state-dom-after-play.png`
    - `output/web-game/ik-tween-segment-2026-02-24-dom/summary-dom.json` confirms keyframe list stable before/after preview playback.
- Added top-row `Masks On/Off` quick button in grid controls:
  - Location: `components/CanvasGrid.tsx` top control strip near `Timeline Panel`.
  - Behavior: globally toggles body-part mask rendering on/off without changing per-part saved settings.
  - Renderer input now receives empty mask map when masks are toggled off.
- Validation: `npm run build` passes, `npm test -- --run` passes (6 files / 31 tests).
- Updated `Masks` button behavior to surface on-canvas upload affordances:
  - When `Masks On`, canvas now shows `+` handles outside the outer ring (one per renderable body part).
  - Clicking a `+` opens the body-part-specific upload picker and routes upload to that part.
  - Handles are styled to indicate existing mask presence and clamped within viewport bounds.
- Adjusted top clamp so `+` handles avoid the top control row as much as possible.
- Validation:
  - `npm run build` passes.
  - Visual verification screenshot: `output/web-game/body-mask-plus-handles-2026-02-24/masks-on-plus-handles-adjusted.png`.
- Updated mask overlay handles to align with connected body parts:
  - Each `+` handle now projects along the ray from ring center -> current part position, then sits outside the outer ring.
  - Added dashed connector lines from each part to its handle.
  - Added per-handle labels near each `+` marker.
- Updated mask handle interactions:
  - `+` click now opens upload/replace for that specific part.
  - Label click opens mask editor for that part.
- Added full right-rail Mask Editor that replaces timeline panel while active:
  - Timeline panel hidden whenever a mask editor target is active.
  - Editor controls include: mode, visibility, opacity, scale, rotate, skew X/Y, offset X/Y, blend mode, filter preset, and custom filter string.
- Extended mask render schema and runtime transform support:
  - New mask fields: `rotationDeg`, `skewXDeg`, `skewYDeg`, `offsetX`, `offsetY`, `blendMode`, `filter`.
  - Renderer now applies mask transform stack + blend + filter in both projection and costume modes.
- Streamlined timeline advanced section body-mask controls:
  - Replaced dense per-part inline controls with guidance + quick `Open Editor` and `Masks On/Off` actions.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (6 files / 31 tests).
  - Playwright visual artifacts:
    - `output/web-game/mask-editor-aligned-handles-2026-02-24/state-1-handles-visible.png`
    - `output/web-game/mask-editor-aligned-handles-2026-02-24/state-2-mask-editor-active.png`
    - status: `plusCount=17`, `maskEditorVisible=1`.
- System audit pass for rotational jitter in live posing:
  - Root cause identified in `components/CanvasGrid.tsx`: smoothing refs (`fkTargetRotationRef`, `fkLastEventTsRef`, IK refs) were being reset on every `currentRotations` prop update.
  - Because `currentRotations` updates continuously during drag, this destroyed temporal continuity and caused micro-stutter/jitter in rotational response.
- Fix applied:
  - Split prop sync and smoothing-reset concerns.
  - `currentRotations` effect now only syncs `rotationsRef` / `lastValidRotationsRef`.
  - Added drag-aware reset effect that clears smoothing refs only when not actively dragging that mode (`IK`/`FK`) and not during playback.
- Validation:
  - `npm run build` passes.
  - `npm test -- --run` passes (6 files / 31 tests).
  - Runtime smoke completed; artifacts written under `output/web-game/rotational-jitter-audit-2026-02-24/`.
- Mask handle de-overlap pass for loading/default mask state:
  - Updated `components/CanvasGrid.tsx` body-mask handle layout to prevent startup stacking at top/bottom clamps.
  - Added viewport-safe orbit radius cap so the handle ring stays within visible bounds.
  - Added angular repulsion/spacing relaxation over preferred joint directions so handles remain spread and deterministic while still tracking body orientation.
- Validation:
  - DOM overlap probe before patch: 17 handles, 10 overlapping pairs.
  - DOM overlap probe after patch: 17 handles, 0 overlapping pairs.
  - Artifact: `output/web-game/mask-overlap-after-v2.png`.
  - `npm run build` passes.
- Built the up-to-date grids, rings, ground plane, and figure surfaces by running the production build.
- Validation:
  - `npm test` passes (6 files, 31 tests).
  - `npm run build` passes.
  - Playwright skill-client attempt (`node "$CODEX_HOME/skills/develop-web-game/scripts/web_game_playwright_client.js" --url http://127.0.0.1:5173 --actions-file ...`) is blocked by Node refusing to treat the skill script as an ES module: `/Users/bradleygeiser/package.json` is `type: "commonjs"`, so the interpreter stops with `SyntaxError: Cannot use import statement outside a module` before any screenshots/state artifacts can be written.
